<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Paradox Macro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #050510;
            color: #e0e6ff;
            padding: 15px;
            overflow: hidden;
            height: 100vh;
            display: flex;
            gap: 15px;
        }

        .main-panel {
            width: 550px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #0a0a15 0%, #1a1225 100%);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            overflow: hidden;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: rgba(10, 10, 20, 0.9);
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        .tab-btn {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            color: #c4b5fd;
        }

        .tab-btn.active {
            color: #a78bfa;
            background: rgba(139, 92, 246, 0.15);
            border-bottom-color: #8b5cf6;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .tab-content::-webkit-scrollbar {
            width: 8px;
        }

        .tab-content::-webkit-scrollbar-track {
            background: rgba(10, 10, 20, 0.5);
            border-radius: 4px;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 4px;
        }

        .side-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 550px;
        }

        .game-container {
            flex: 1;
            background: #0a0a15;
            border: 3px solid rgba(139, 92, 246, 0.7);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .game-container-header {
            padding: 8px 12px;
            background: rgba(10, 10, 20, 0.95);
            border-bottom: 2px solid rgba(139, 92, 246, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-container-header h3 {
            font-size: 14px;
            color: #a78bfa;
            font-weight: 600;
        }

        .game-container-controls {
            display: flex;
            gap: 8px;
        }

        .game-container-controls button {
            padding: 5px 12px;
            font-size: 12px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 6px;
            color: #c4b5fd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .game-container-controls button:hover {
            background: rgba(139, 92, 246, 0.4);
        }

        .game-embed-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a15;
            position: relative;
        }

        .status-indicator {
            padding: 6px 12px;
            background: rgba(10, 10, 20, 0.9);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 6px;
            font-size: 12px;
            color: #c4b5fd;
        }

        .status-indicator.attached {
            color: #4ade80;
            border-color: rgba(74, 222, 128, 0.4);
        }

        .section {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #c4b5fd;
            font-size: 14px;
            font-weight: 500;
        }

        select, input {
            width: 100%;
            padding: 12px 14px;
            background: rgba(10, 10, 20, 0.8);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: #e0e6ff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        select option {
            background: #0a0a15;
            color: #e0e6ff;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 0;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .keybind-group {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .keybind-group input {
            flex: 1;
        }

        .keybind-group button {
            padding: 12px 20px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 8px;
            color: #c4b5fd;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .keybind-group button:hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
        }

        .btn-secondary {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: #8b5cf6;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .status-box {
            background: rgba(10, 10, 20, 0.9);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 16px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.7;
        }

        .status-box::-webkit-scrollbar {
            width: 8px;
        }

        .status-box::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
        }

        .status-box::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 4px;
        }

        .status-line {
            color: #93c5fd;
            margin-bottom: 4px;
        }

        .status-line.success {
            color: #4ade80;
        }

        .status-line.error {
            color: #f87171;
        }

        .status-line.warning {
            color: #fbbf24;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .running-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Unit Cards */
        .unit-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .unit-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .unit-index {
            font-weight: 600;
            color: #a78bfa;
            font-size: 13px;
            min-width: 50px;
        }

        .unit-fields {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 6px;
        }

        .unit-field {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .unit-field label {
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 0;
        }

        .unit-field input,
        .unit-field select {
            padding: 6px 8px;
            font-size: 11px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 4px;
            color: #e0e6ff;
        }

        .unit-coords {
            grid-column: span 4;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
        }

        .btn-pick {
            padding: 6px 10px;
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 4px;
            color: #c084fc;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .btn-pick:hover {
            background: rgba(168, 85, 247, 0.3);
            border-color: #a855f7;
        }

        .unit-note {
            grid-column: span 4;
        }

        .unit-note input {
            width: 100%;
        }

        .config-display {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #c4b5fd;
        }

        .copy-paste-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
        }

        .copy-paste-row span {
            font-size: 13px;
            color: #94a3b8;
        }

        .copy-paste-row select {
            padding: 8px 12px;
            font-size: 13px;
            width: auto;
        }

        .copy-paste-row button {
            padding: 8px 16px;
            font-size: 13px;
        }

        .units-scroll {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .units-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .units-scroll::-webkit-scrollbar-track {
            background: rgba(10, 10, 20, 0.5);
            border-radius: 3px;
        }

        .units-scroll::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 3px;
        }

        /* Map Preview */
        .map-preview-container {
            position: relative;
            margin-bottom: 12px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.3);
            background: rgba(10, 10, 20, 0.5);
        }

        .map-preview-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .map-preview-placeholder {
            padding: 30px;
            text-align: center;
            color: #94a3b8;
            font-size: 12px;
        }

        .unit-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.3);
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .unit-dot:hover {
            transform: translate(-50%, -50%) scale(1.3);
            background: rgba(0, 255, 0, 0.6);
        }

        .unit-dot-label {
            position: absolute;
            font-size: 8px;
            font-weight: bold;
            color: #00ff00;
            transform: translate(-50%, -150%);
            text-shadow: 0 0 3px #000, 0 0 3px #000;
            pointer-events: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="main-panel">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('stage')">üéÆ Stage</button>
            <button class="tab-btn" onclick="switchTab('units')">‚öîÔ∏è Units</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab-btn" onclick="switchTab('update')">üîÑ Update</button>
            <button class="tab-btn" onclick="switchTab('guide')">üìñ Guide</button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Stage Tab -->
            <div id="tab-stage" class="tab-panel active">
                <div class="section">
                    <div class="section-title">Stage Selection</div>
                    
                    <div class="form-group">
                        <label for="mode">Mode</label>
                        <select id="mode" onchange="updateModeVisibility(); saveStoryConfig();">
                            <option value="Story">Story</option>
                            <option value="Legend">Legend</option>
                            <option value="Raids">Raids</option>
                            <option value="Siege">Siege</option>
                        </select>
                    </div>

                    <div id="story-options">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="location">Location</label>
                                <select id="location" onchange="saveStoryConfig(); loadUnitConfig();">
                                    <option value="Leaf Village">Leaf Village</option>
                                    <option value="Planet Namek">Planet Namek</option>
                                    <option value="Dark Hollow">Dark Hollow</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="act">Act</label>
                                <select id="act" onchange="saveStoryConfig(); loadUnitConfig();">
                                    <option value="Act 1">Act 1</option>
                                    <option value="Act 2">Act 2</option>
                                    <option value="Act 3">Act 3</option>
                                    <option value="Act 4">Act 4</option>
                                    <option value="Act 5">Act 5</option>
                                    <option value="Act 6">Act 6</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="nightmare" onchange="saveStoryConfig();">
                                <span>Nightmare Mode</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Quick Actions</div>
                    <p style="color: #94a3b8; margin-bottom: 16px; font-size: 14px;">
                        Press <strong style="color: #a78bfa;">F1</strong> to start, <strong style="color: #a78bfa;">F3</strong> to stop
                    </p>
                </div>

                <div class="section">
                    <div class="section-title">Macro Status</div>
                    <div class="status-box" id="status-log">
                        <div class="status-line">Ready. Press F1 to start, F3 to stop.</div>
                    </div>
                </div>
            </div>

            <!-- Units Tab -->
            <div id="tab-units" class="tab-panel">
                <div class="config-display">
                    Current Config: <strong id="unit-config-display">Leaf Village - Act 1</strong>
                </div>

                <div class="map-preview-container" id="map-preview-container">
                    <div class="map-preview-placeholder" id="map-placeholder">
                        üñºÔ∏è No map image yet. Press F4 in-game to take a screenshot.
                    </div>
                    <img id="map-preview-img" style="display: none;" alt="Map Preview">
                    <div id="unit-dots-container"></div>
                </div>

                <div class="units-scroll">
                    <div id="units-container"></div>
                </div>

                <div class="btn-group" style="margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="loadUnitConfig()">‚Üª Refresh</button>
                    <button class="btn btn-primary" onclick="saveUnitConfig()">üíæ Save</button>
                    <button class="btn btn-secondary" onclick="clearUnitConfig()" style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); color: #fca5a5;">üóëÔ∏è Clear All</button>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-panel">
                <div class="section">
                    <div class="section-title">Keybinds</div>
                    
                    <div class="form-group">
                        <label>Start Keybind</label>
                        <div class="keybind-group">
                            <input type="text" id="start-key" value="F1" readonly>
                            <button onclick="captureKey('start')">Set</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Stop Keybind</label>
                        <div class="keybind-group">
                            <input type="text" id="stop-key" value="F3" readonly>
                            <button onclick="captureKey('stop')">Set</button>
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="applyKeybinds()">Apply Keybinds</button>
                </div>

                <div class="section">
                    <div class="section-title">Macro Timing</div>
                    <div class="form-group">
                        <label>Delay between 'T' presses (seconds)</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="number" id="t-press-delay" step="0.01" min="0" value="0.08" style="width:120px;">
                            <button class="btn btn-secondary" onclick="applyTPressDelay()">Apply</button>
                        </div>
                        <p style="color:#94a3b8; margin-top:8px; font-size:12px;">Controls how quickly 'T' is pressed when attempting upgrades.</p>
                    </div>
                </div>
                <div class="section">
                    <div class="section-title">Game Window</div>
                    <p style="color: #94a3b8; margin-bottom: 16px; font-size: 14px;">
                        Attach the Roblox window to see it in the side panel.
                    </p>
                </div>
            </div>

            <!-- Update Tab -->
            <div id="tab-update" class="tab-panel">
                <div class="section">
                    <div class="section-title">üîÑ Auto-Update</div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <p style="color: #e0e6ff; font-size: 14px; margin-bottom: 4px;">Current Version</p>
                            <p style="color: #a78bfa; font-size: 24px; font-weight: 600;" id="current-version">Loading...</p>
                        </div>
                        <button class="btn btn-secondary" onclick="checkForUpdates()" id="check-update-btn">
                            üîç Check for Updates
                        </button>
                    </div>
                    
                    <div id="update-status" style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; margin-bottom: 16px; display: none;">
                        <p id="update-status-text" style="color: #94a3b8; font-size: 14px;"></p>
                    </div>
                    
                    <div id="update-available" style="display: none; padding: 16px; background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 10px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üéâ</span>
                            <div>
                                <p style="color: #4ade80; font-size: 16px; font-weight: 600;">Update Available!</p>
                                <p style="color: #94a3b8; font-size: 14px;">Version <span id="new-version" style="color: #4ade80; font-weight: 600;"></span> is ready to download</p>
                            </div>
                        </div>
                        
                        <div id="release-notes" style="background: rgba(10, 10, 20, 0.5); padding: 12px; border-radius: 6px; margin-bottom: 16px; max-height: 150px; overflow-y: auto;">
                            <p style="color: #94a3b8; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Release Notes</p>
                            <p id="release-notes-text" style="color: #e0e6ff; font-size: 13px; line-height: 1.6; white-space: pre-wrap;"></p>
                        </div>
                        
                        <button class="btn btn-primary" onclick="installUpdate()" id="install-update-btn" style="width: 100%; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-color: rgba(74, 222, 128, 0.5);">
                            ‚¨áÔ∏è Download & Install Update
                        </button>
                    </div>
                    
                    <div id="no-update" style="display: none; padding: 16px; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 10px; text-align: center;">
                        <span style="font-size: 32px;">‚úÖ</span>
                        <p style="color: #4ade80; font-size: 16px; font-weight: 500; margin-top: 8px;">You're up to date!</p>
                        <p style="color: #94a3b8; font-size: 13px; margin-top: 4px;">You have the latest version installed.</p>
                    </div>
                    
                    <div id="update-progress" style="display: none; padding: 16px; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div class="spinner" style="width: 24px; height: 24px; border: 3px solid rgba(139, 92, 246, 0.3); border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p id="progress-text" style="color: #e0e6ff; font-size: 14px;">Preparing update...</p>
                        </div>
                        <div style="background: rgba(10, 10, 20, 0.5); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="progress-bar" style="background: linear-gradient(90deg, #8b5cf6, #a78bfa); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <div id="update-complete" style="display: none; padding: 16px; background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 10px; text-align: center;">
                        <span style="font-size: 32px;">üéâ</span>
                        <p style="color: #4ade80; font-size: 16px; font-weight: 600; margin-top: 8px;">Update Complete!</p>
                        <p style="color: #94a3b8; font-size: 13px; margin-top: 4px; margin-bottom: 16px;">Please restart the application to apply changes.</p>
                        <button class="btn btn-primary" onclick="restartApp()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-color: rgba(74, 222, 128, 0.5);">
                            üîÑ Restart Now
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">‚ÑπÔ∏è About</div>
                    <p style="color: #94a3b8; font-size: 13px; line-height: 1.6;">
                        <strong style="color: #e0e6ff;">AnimeParadoxMacro</strong><br>
                        An automation tool for Roblox Anime games.<br><br>
                        Updates are downloaded from GitHub and installed automatically.<br>
                        Your configuration files (unit placements, keybinds) are preserved during updates.
                    </p>
                </div>
            </div>

            <!-- Guide Tab -->
            <div id="tab-guide" class="tab-panel">
                <div class="section">
                    <div class="section-title">üìñ How to Use</div>
                    
                    <h3 style="color: #a78bfa; margin-top: 16px; margin-bottom: 8px; font-size: 16px;">üéÆ Getting Started</h3>
                    <p style="color: #94a3b8; line-height: 1.6; margin-bottom: 12px;">
                        1. <strong style="color: #e0e6ff;">Select your Stage</strong> - Choose Mode (Story/Legend/Raids/Siege), Location, and Act<br>
                        2. <strong style="color: #e0e6ff;">Configure Units</strong> - Go to Units tab to set up your unit placements<br>
                        3. <strong style="color: #e0e6ff;">Start Macro</strong> - Press <strong style="color: #a78bfa;">F1</strong> to begin automation<br>
                        4. <strong style="color: #e0e6ff;">Stop Macro</strong> - Press <strong style="color: #a78bfa;">F3</strong> to stop at any time
                    </p>

                    <h3 style="color: #a78bfa; margin-top: 20px; margin-bottom: 8px; font-size: 16px;">‚öîÔ∏è Unit Configuration</h3>
                    <p style="color: #94a3b8; line-height: 1.6; margin-bottom: 8px;">
                        <strong style="color: #e0e6ff;">On</strong> - Enable/disable this unit<br>
                        <strong style="color: #e0e6ff;">Early</strong> - Place unit before clicking starting the stage<br>
                        <strong style="color: #e0e6ff;">Auto‚¨Ü</strong> - Toggles auto upgrade<br>
                        <strong style="color: #e0e6ff;">Slot</strong> - Hotkey slot (1-6) or 0 for clicking use 0 if you're upgrading<br>
                        <strong style="color: #e0e6ff;">Upgrade</strong> - Target upgrade level (0-4) or Max<br>
                        <strong style="color: #e0e6ff;">X/Y</strong> - Placement coordinates on the map<br>
                        <strong style="color: #e0e6ff;">üìç Pick</strong> - Click to open coordinate picker tool press f4 to get your custom placement image<br>
                        <strong style="color: #e0e6ff;">Note</strong> - Optional reminder text for this unit
                    </p>

                    <h3 style="color: #a78bfa; margin-top: 20px; margin-bottom: 8px; font-size: 16px;">üìã Copy & Paste Units</h3>
                    <p style="color: #94a3b8; line-height: 1.6; margin-bottom: 12px;">
                        Each unit has <strong style="color: #e0e6ff;">üìã</strong> (Copy) and <strong style="color: #e0e6ff;">üì•</strong> (Paste) buttons:<br>
                        1. Click <strong>üìã</strong> on the unit you want to copy<br>
                        2. Click <strong>üì•</strong> on the unit you want to paste to<br>
                        3. All settings (except unit number) will be copied
                    </p>

                    <h3 style="color: #a78bfa; margin-top: 20px; margin-bottom: 8px; font-size: 16px;">üóëÔ∏è Clear All Units</h3>
                    <p style="color: #94a3b8; line-height: 1.6; margin-bottom: 12px;">
                        Click the <strong style="color: #fca5a5;">üóëÔ∏è Clear All</strong> button at the bottom of Units tab to reset all units to default settings (disabled, slot 0, no coordinates).
                    </p>

                    <h3 style="color: #a78bfa; margin-top: 20px; margin-bottom: 8px; font-size: 16px;">‚öôÔ∏è Settings</h3>
                    <p style="color: #94a3b8; line-height: 1.6; margin-bottom: 12px;">
                        <strong style="color: #e0e6ff;">Keybinds</strong> - Customize Start/Stop hotkeys (default: F1/F3)<br>
                        <strong style="color: #e0e6ff;">T Press Delay</strong> - Adjust speed of upgrade key presses (default: 0.08s)
                    </p>

                    <h3 style="color: #a78bfa; margin-top: 20px; margin-bottom: 8px; font-size: 16px;">üìä Reading the Status Log</h3>
                    <p style="color: #94a3b8; line-height: 1.6; margin-bottom: 8px;">
                        The status log on the Stage tab shows real-time macro activity:<br>
                        <span style="color: #10b981;">‚úì Green text</span> - Successful actions<br>
                        <span style="color: #ef4444;">‚úó Red text</span> - Failed actions or errors<br>
                        <span style="color: #f59e0b;">‚ö† Yellow text</span> - Warnings or important info<br>
                        <span style="color: #94a3b8;">Gray text</span> - General status updates
                    </p>

                    <h3 style="color: #a78bfa; margin-top: 20px; margin-bottom: 8px; font-size: 16px;">üîë Tips & Best Practices</h3>
                    <p style="color: #94a3b8; line-height: 1.6; margin-bottom: 12px;">
                        ‚Ä¢ Always <strong style="color: #e0e6ff;">Save</strong> after configuring units<br>
                        ‚Ä¢ Use <strong style="color: #e0e6ff;">Refresh</strong> to reload saved configurations<br>
                        ‚Ä¢ Use <strong style="color: #e0e6ff;">Early</strong> placement for important units that need to be placed before the game starts (farm) <br>
                        ‚Ä¢ Set <strong style="color: #e0e6ff;">Slot 0</strong> for clicking units to upgrade (click-only placement)<br>
                        ‚Ä¢ Use <strong style="color: #e0e6ff;">Notes</strong> to remember unit names and where they are in the config<br>
                        ‚Ä¢ Copy/Paste is useful for duplicating similar unit setups<br>
                        ‚Ä¢ Monitor the status log to ensure macro is working correctly
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Panel - Game Overlay -->
    <div class="side-panel">
        <div class="game-container">
            <div class="game-container-header">
                <h3>üéÆ Game View</h3>
                <div class="game-container-controls">
                    <button onclick="attachRoblox()">Attach Roblox</button>
                    <button onclick="detachRoblox()">Detach</button>
                </div>
            </div>
            <div class="game-embed-area" id="game-embed">
                <div class="status-indicator" id="roblox-status">Not Attached</div>
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;

        // Tab switching
        function switchTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            // Deactivate all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Show selected panel
            document.getElementById('tab-' + tabName).classList.add('active');
            // Activate button
            event.target.classList.add('active');
        }

        function updateModeVisibility() {
            const mode = document.getElementById('mode').value;
            const storyOptions = document.getElementById('story-options');
            const locationSelect = document.getElementById('location');
            const actSelect = document.getElementById('act');
            
            if (mode === 'Story' || mode === 'Legend') {
                storyOptions.classList.remove('hidden');
                
                // For Legend mode, restrict locations and acts
                if (mode === 'Legend') {
                    // Disable Leaf Village for Legend
                    Array.from(locationSelect.options).forEach(opt => {
                        opt.disabled = (opt.value === 'Leaf Village');
                    });
                    // If Leaf Village is selected, switch to Planet Namek
                    if (locationSelect.value === 'Leaf Village') {
                        locationSelect.value = 'Planet Namek';
                    }
                    // For Legend, only Acts 1-3 available
                    Array.from(actSelect.options).forEach(opt => {
                        const actNum = parseInt(opt.value.replace('Act ', ''));
                        opt.disabled = (actNum > 3);
                    });
                    // If Act > 3 is selected, switch to Act 1
                    const currentAct = parseInt(actSelect.value.replace('Act ', ''));
                    if (currentAct > 3) {
                        actSelect.value = 'Act 1';
                    }
                } else {
                    // Story mode - enable all options
                    Array.from(locationSelect.options).forEach(opt => {
                        opt.disabled = false;
                    });
                    Array.from(actSelect.options).forEach(opt => {
                        opt.disabled = false;
                    });
                }
            } else {
                storyOptions.classList.add('hidden');
            }
        }
        
        async function saveStoryConfig() {
            try {
                const mode = document.getElementById('mode').value;
                const location = document.getElementById('location').value;
                const act = document.getElementById('act').value;
                const nightmare = document.getElementById('nightmare').checked;
                
                await pywebview.api.update_story_config(mode, location, act, nightmare);
                console.log('Story config updated:', mode, location, act, 'nightmare:', nightmare);
            } catch (error) {
                console.error('Error updating story config:', error);
            }
        }

        // Roblox Window Attachment
        async function attachRoblox() {
            try {
                const result = await pywebview.api.attach_roblox();
                const statusEl = document.getElementById('roblox-status');
                if (result.success) {
                    statusEl.textContent = 'Attached';
                    statusEl.classList.add('attached');
                    addStatus('Roblox window attached!', 'success');
                } else {
                    statusEl.textContent = result.message || 'Failed';
                    statusEl.classList.remove('attached');
                    addStatus(result.message, 'error');
                }
            } catch (error) {
                addStatus('Error attaching Roblox: ' + error, 'error');
            }
        }

        async function detachRoblox() {
            try {
                await pywebview.api.detach_roblox();
                const statusEl = document.getElementById('roblox-status');
                statusEl.textContent = 'Not Attached';
                statusEl.classList.remove('attached');
                addStatus('Roblox window detached', 'warning');
            } catch (error) {
                addStatus('Error detaching Roblox: ' + error, 'error');
            }
        }

        async function captureKey(type) {
            const input = document.getElementById(type + '-key');
            input.value = 'Press any key...';
            input.style.background = 'rgba(139, 92, 246, 0.2)';
            
            try {
                const key = await pywebview.api.capture_keybind(type);
                input.value = key.toUpperCase();
                input.style.background = '';
            } catch (error) {
                console.error('Error capturing key:', error);
                input.value = type === 'start' ? 'F1' : 'F3';
                input.style.background = '';
            }
        }

        async function applyKeybinds() {
            const startKey = document.getElementById('start-key').value;
            const stopKey = document.getElementById('stop-key').value;
            
            try {
                await pywebview.api.apply_keybinds(startKey, stopKey);
                addStatus('Hotkeys registered: Start=' + startKey + ', Stop=' + stopKey, 'success');
            } catch (error) {
                addStatus('Failed to register hotkeys: ' + error, 'error');
            }
        }

        async function loadStoryConfig() {
            try {
                const config = await pywebview.api.get_config();
                if (config.mode) {
                    document.getElementById('mode').value = config.mode;
                }
                if (config.location) {
                    document.getElementById('location').value = config.location;
                }
                if (config.act) {
                    document.getElementById('act').value = config.act;
                }
                document.getElementById('nightmare').checked = config.nightmare || false;
                // Load T-press delay setting if present
                try {
                    const tdelay = (config.t_press_delay !== undefined) ? parseFloat(config.t_press_delay) : 0.08;
                    document.getElementById('t-press-delay').value = isNaN(tdelay) ? 0.08 : tdelay;
                } catch (e) {
                    document.getElementById('t-press-delay').value = 0.08;
                }
                updateModeVisibility();
                console.log('Loaded story config:', config.mode, config.location, config.act, 'nightmare:', config.nightmare);
            } catch (error) {
                console.error('Error loading story config:', error);
            }
        }

        async function applyTPressDelay() {
            const input = document.getElementById('t-press-delay');
            const val = parseFloat(input.value);
            if (isNaN(val) || val < 0) {
                addStatus('Invalid T-press delay value', 'error');
                return;
            }
            try {
                const ok = await pywebview.api.update_t_press_delay(val);
                if (ok) {
                    addStatus('T-press delay updated: ' + val + 's', 'success');
                } else {
                    addStatus('Failed to update T-press delay', 'error');
                }
            } catch (err) {
                addStatus('Error updating T-press delay: ' + err, 'error');
            }
        }

        function addStatus(message, type = '') {
            const statusLog = document.getElementById('status-log');
            const line = document.createElement('div');
            line.className = 'status-line ' + type;
            
            if (isRunning && type === '') {
                line.innerHTML = '<span class="running-indicator"></span>' + message;
            } else {
                line.textContent = message;
            }
            
            statusLog.appendChild(line);
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        // Unit Configuration Functions
        let currentUnitConfig = null;

        async function loadUnitConfig() {
            try {
                const locationEl = document.getElementById('location');
                const actEl = document.getElementById('act');
                const location = locationEl ? locationEl.value : 'Leaf Village';
                const act = actEl ? actEl.value : 'Act 1';
                
                // Update display
                const displayEl = document.getElementById('unit-config-display');
                if (displayEl) {
                    displayEl.textContent = `${location} - ${act}`;
                }
                
                const config = await pywebview.api.load_unit_config(location, act);
                currentUnitConfig = config;
                renderUnits(config.Units);
                await loadMapPreview(location, act);
                addStatus(`Loaded unit config for ${location} - ${act}`, 'success');
            } catch (error) {
                addStatus('Error loading unit config: ' + error, 'error');
                console.error('Unit config error:', error);
            }
        }

        async function loadMapPreview(location, act) {
            try {
                const result = await pywebview.api.get_map_preview_path(location, act);
                const img = document.getElementById('map-preview-img');
                const placeholder = document.getElementById('map-placeholder');
                const dotsContainer = document.getElementById('unit-dots-container');
                
                console.log('Map preview result:', result);
                
                if (result && result.success && result.path) {
                    // Set up load handler first
                    img.onload = async function() {
                        console.log('Image loaded successfully');
                        await renderUnitDots();
                    };
                    
                    img.onerror = function(e) {
                        console.error('Image failed to load:', e);
                        img.style.display = 'none';
                        placeholder.style.display = 'block';
                        placeholder.textContent = '‚ùå Failed to load map image';
                    };
                    
                    // Load the image (base64 data URL)
                    img.src = result.path;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                } else {
                    console.log('No map preview available');
                    img.style.display = 'none';
                    placeholder.style.display = 'block';
                    dotsContainer.innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading map preview:', error);
            }
        }

        async function renderUnitDots() {
            const dotsContainer = document.getElementById('unit-dots-container');
            const img = document.getElementById('map-preview-img');
            dotsContainer.innerHTML = '';
            
            console.log('renderUnitDots called', {hasConfig: !!currentUnitConfig, imgDisplay: img?.style.display});
            
            if (!currentUnitConfig || !img || img.style.display === 'none') {
                console.log('Cannot render dots: missing config or image not visible');
                return;
            }
            
            // Get the image display dimensions
            const imgRect = img.getBoundingClientRect();
            console.log('Image rect:', imgRect);
            
            // Use saved window info from config if available, otherwise try current Roblox window
            let windowInfo = currentUnitConfig.WindowInfo || null;
            console.log('Window info from config:', windowInfo);
            
            if (!windowInfo) {
                try {
                    windowInfo = await pywebview.api.get_roblox_window_info();
                } catch (e) {
                    console.log('Could not get window info, using defaults');
                    windowInfo = { x: 0, y: 0, width: 960, height: 600 };
                }
            }
            
            // Scale factors from screen coordinates to preview image
            const scaleX = imgRect.width / windowInfo.width;
            const scaleY = imgRect.height / windowInfo.height;
            
            console.log('Scale factors:', {scaleX, scaleY, windowInfo});
            
            let dotCount = 0;
            currentUnitConfig.Units.forEach((unit, idx) => {
                const screenX = parseInt(unit.X) || 0;
                const screenY = parseInt(unit.Y) || 0;
                
                if (screenX === 0 && screenY === 0) return; // Skip units without coordinates
                
                // Convert absolute screen coordinates to relative position within the Roblox window
                const relativeX = screenX - windowInfo.x;
                const relativeY = screenY - windowInfo.y;
                
                // Scale to preview image size
                const dotX = relativeX * scaleX;
                const dotY = relativeY * scaleY;
                
                console.log(`Unit ${unit.Index}: screen(${screenX},${screenY}) -> relative(${relativeX},${relativeY}) -> dot(${dotX},${dotY})`);
                
                // Skip if outside bounds
                if (dotX < 0 || dotX > imgRect.width || dotY < 0 || dotY > imgRect.height) {
                    console.log(`Unit ${unit.Index} outside bounds, skipping`);
                    return;
                }
                
                // Create the dot element
                const dot = document.createElement('div');
                dot.className = 'unit-dot';
                dot.style.left = `${dotX}px`;
                dot.style.top = `${dotY}px`;
                dot.title = `Unit ${unit.Index}: (${screenX}, ${screenY})${unit.Note ? ' - ' + unit.Note : ''}`;
                dot.onclick = () => {
                    // Scroll to this unit in the list
                    const unitCard = document.querySelector(`#unit-${idx}-enabled`)?.closest('.unit-card');
                    if (unitCard) unitCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                };
                
                // Create the label
                const label = document.createElement('div');
                label.className = 'unit-dot-label';
                label.style.left = `${dotX}px`;
                label.style.top = `${dotY}px`;
                label.textContent = `U${unit.Index}`;
                
                dotsContainer.appendChild(dot);
                dotsContainer.appendChild(label);
                dotCount++;
            });
            
            console.log(`Rendered ${dotCount} dots`);
        }

        function renderUnits(units) {
            const container = document.getElementById('units-container');
            container.innerHTML = '';
            
            units.forEach((unit, idx) => {
                const unitDiv = document.createElement('div');
                unitDiv.className = 'unit-card';
                unitDiv.innerHTML = `
                    <div class="unit-header">
                        <span class="unit-index">Unit ${unit.Index}</span>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" id="unit-${idx}-enabled" 
                                   ${unit.Enabled ? 'checked' : ''}
                                   onchange="updateUnitEnabled(${idx}, this.checked)"
                                   style="width: 14px; height: 14px;">
                            <span style="font-size: 11px; color: #94a3b8;">On</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" id="unit-${idx}-placebeforeyes"
                                   ${unit.PlaceBeforeYes ? 'checked' : ''}
                                   onchange="updateUnitField(${idx}, 'PlaceBeforeYes', this.checked)"
                                   style="width: 14px; height: 14px;">
                            <span style="font-size: 11px; color: #94a3b8;">Early</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" id="unit-${idx}-autoupgrade"
                                   ${unit.AutoUpgrade ? 'checked' : ''}
                                   onchange="updateUnitField(${idx}, 'AutoUpgrade', this.checked)"
                                   style="width: 14px; height: 14px;">
                            <span style="font-size: 11px; color: #94a3b8;">Auto‚¨Ü</span>
                        </label>
                        <button onclick="copyUnit(${idx})" style="padding: 3px 6px; font-size: 10px; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 4px; color: #c4b5fd; cursor: pointer; margin-left: auto;">üìã</button>
                        <button onclick="pasteUnit(${idx})" style="padding: 3px 6px; font-size: 10px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 4px; color: #86efac; cursor: pointer;">üì•</button>
                    </div>
                    <div class="unit-fields">
                        <div class="unit-field">
                            <label>Slot</label>
                            <select id="unit-${idx}-slot" onchange="updateUnitField(${idx}, 'Slot', this.value)">
                                ${[0,1,2,3,4,5,6].map(n => 
                                    `<option value="${n}" ${unit.Slot == n ? 'selected' : ''}>${n === 0 ? '0' : n}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="unit-field">
                            <label>Upgrade</label>
                            <select id="unit-${idx}-upgrade" onchange="updateUnitField(${idx}, 'Upgrade', this.value)">
                                ${[0,1,2,3,4,'Max'].map(n => 
                                    `<option value="${n}" ${(unit.Upgrade == n || (unit.Upgrade === 'Max' && n === 'Max')) ? 'selected' : ''}>${n}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="unit-field">
                            <label>X</label>
                            <input type="number" id="unit-${idx}-x" value="${unit.X || 0}"
                                   onchange="updateUnitField(${idx}, 'X', this.value)">
                        </div>
                        <div class="unit-field">
                            <label>Y</label>
                            <input type="number" id="unit-${idx}-y" value="${unit.Y || 0}"
                                   onchange="updateUnitField(${idx}, 'Y', this.value)">
                        </div>
                        <div class="unit-coords">
                            <div class="unit-field">
                                <label>&nbsp;</label>
                                <button class="btn-pick" onclick="openCoordinatePicker(${idx})">
                                    üìç Pick
                                </button>
                            </div>
                            <div class="unit-field" style="grid-column: span 3;">
                                <label>Note</label>
                                <input type="text" id="unit-${idx}-note" value="${unit.Note || ''}"
                                       placeholder="e.g., Front line"
                                       onchange="updateUnitField(${idx}, 'Note', this.value)">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(unitDiv);
            });
        }

        function updateUnitEnabled(idx, enabled) {
            if (currentUnitConfig && currentUnitConfig.Units[idx]) {
                currentUnitConfig.Units[idx].Enabled = enabled;
            }
        }

        function updateUnitField(idx, field, value) {
            if (currentUnitConfig && currentUnitConfig.Units[idx]) {
                currentUnitConfig.Units[idx][field] = value;
                // Re-render dots when coordinates change
                if (field === 'X' || field === 'Y') {
                    renderUnitDots();
                }
            }
        }

        // Copy/Paste unit functionality - per unit
        let copiedUnitData = null;

        function copyUnit(idx) {
            if (currentUnitConfig && currentUnitConfig.Units[idx]) {
                const source = currentUnitConfig.Units[idx];
                copiedUnitData = {
                    Enabled: source.Enabled,
                    PlaceBeforeYes: source.PlaceBeforeYes,
                    AutoUpgrade: source.AutoUpgrade,
                    Slot: source.Slot,
                    X: source.X,
                    Y: source.Y,
                    Upgrade: source.Upgrade,
                    Note: source.Note
                };
                addStatus(`Copied Unit ${idx + 1}`, 'success');
            }
        }

        function pasteUnit(idx) {
            if (!copiedUnitData) {
                addStatus('Copy a unit first!', 'warning');
                return;
            }
            
            if (currentUnitConfig && currentUnitConfig.Units[idx]) {
                const target = currentUnitConfig.Units[idx];
                target.Enabled = copiedUnitData.Enabled;
                target.PlaceBeforeYes = copiedUnitData.PlaceBeforeYes;
                target.AutoUpgrade = copiedUnitData.AutoUpgrade;
                target.Slot = copiedUnitData.Slot;
                target.X = copiedUnitData.X;
                target.Y = copiedUnitData.Y;
                target.Upgrade = copiedUnitData.Upgrade;
                target.Note = copiedUnitData.Note;
                
                renderUnits(currentUnitConfig.Units);
                addStatus(`Pasted to Unit ${idx + 1}`, 'success');
            }
        }

        function clearUnitConfig() {
            if (!currentUnitConfig) return;
            
            currentUnitConfig.Units.forEach((unit, idx) => {
                unit.Enabled = false;
                unit.PlaceBeforeYes = false;
                unit.AutoUpgrade = false;
                unit.Slot = 0;
                unit.X = 0;
                unit.Y = 0;
                unit.Upgrade = 0;
                unit.Note = '';
            });
            renderUnits(currentUnitConfig.Units);
            addStatus('All units cleared to default', 'success');
        }

        async function saveUnitConfig() {
            try {
                const locationEl = document.getElementById('location');
                const actEl = document.getElementById('act');
                const location = locationEl ? locationEl.value : 'Leaf Village';
                const act = actEl ? actEl.value : 'Act 1';
                await pywebview.api.save_unit_config(location, act, currentUnitConfig);
                addStatus(`Unit config saved for ${location} - ${act}!`, 'success');
            } catch (error) {
                addStatus('Error saving unit config: ' + error, 'error');
                console.error(error);
            }
        }

        async function openCoordinatePicker(unitIndex) {
            try {
                const locationEl = document.getElementById('location');
                const actEl = document.getElementById('act');
                const location = locationEl ? locationEl.value : 'Leaf Village';
                const act = actEl ? actEl.value : 'Act 1';
                const actualIndex = unitIndex + 1; // Convert 0-based to 1-based
                
                // Save current config before opening picker
                await saveUnitConfig();
                
                addStatus(`Opening coordinate picker for Unit ${actualIndex}...`, 'info');
                
                const result = await pywebview.api.open_coordinate_picker(location, act, actualIndex);
                
                if (result.success && result.x !== undefined && result.y !== undefined) {
                    // Reload the config to get updated WindowInfo and coordinates
                    await loadUnitConfig();
                    
                    addStatus(`Coordinates set for Unit ${actualIndex}: (${result.x}, ${result.y})`, 'success');
                } else {
                    addStatus('Coordinate picker closed without selection', 'warning');
                }
            } catch (error) {
                addStatus('Error opening coordinate picker: ' + error, 'error');
                console.error(error);
            }
        }

        // Initialize on load
        window.addEventListener('pywebviewready', async function() {
            console.log('pywebviewready event fired');
            await loadStoryConfig();
            // Wait a bit for story config to populate
            setTimeout(async () => {
                await loadUnitConfig();
            }, 100);
            
            // Load current version
            loadCurrentVersion();
            
            // Poll for status updates
            setInterval(async () => {
                try {
                    const updates = await pywebview.api.get_status_updates();
                    updates.forEach(msg => {
                        if (msg.toLowerCase().includes('macro started') || msg.toLowerCase().includes('start hotkey')) {
                            isRunning = true;
                        } else if (msg.toLowerCase().includes('macro stopped') || msg.toLowerCase().includes('stop hotkey')) {
                            isRunning = false;
                        }
                        addStatus(msg);
                    });
                } catch (error) {
                    console.error('Error getting status updates:', error);
                }
            }, 500);
        });

        // ============== Update Functions ==============
        let pendingUpdateUrl = null;

        async function loadCurrentVersion() {
            try {
                const result = await pywebview.api.get_version();
                document.getElementById('current-version').textContent = 'v' + result.version;
            } catch (error) {
                document.getElementById('current-version').textContent = 'Unknown';
                console.error('Error loading version:', error);
            }
        }

        async function checkForUpdates() {
            const btn = document.getElementById('check-update-btn');
            const statusDiv = document.getElementById('update-status');
            const statusText = document.getElementById('update-status-text');
            const updateAvailable = document.getElementById('update-available');
            const noUpdate = document.getElementById('no-update');
            
            // Hide previous results
            updateAvailable.style.display = 'none';
            noUpdate.style.display = 'none';
            document.getElementById('update-complete').style.display = 'none';
            document.getElementById('update-progress').style.display = 'none';
            
            // Show status
            statusDiv.style.display = 'block';
            statusText.textContent = 'üîç Checking for updates...';
            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';
            
            try {
                const result = await pywebview.api.check_for_updates();
                
                if (!result.success) {
                    statusText.textContent = '‚ùå ' + result.message;
                    statusText.style.color = '#ef4444';
                    return;
                }
                
                statusDiv.style.display = 'none';
                
                if (result.update_available) {
                    // Show update available
                    document.getElementById('new-version').textContent = 'v' + result.latest_version;
                    document.getElementById('release-notes-text').textContent = result.release_notes || 'No release notes available.';
                    pendingUpdateUrl = result.download_url;
                    updateAvailable.style.display = 'block';
                    addStatus(`Update available: v${result.latest_version}`, 'success');
                } else {
                    // No update available
                    noUpdate.style.display = 'block';
                    addStatus('You are running the latest version.', 'info');
                }
                
            } catch (error) {
                statusText.textContent = '‚ùå Error: ' + error;
                statusText.style.color = '#ef4444';
                console.error('Error checking for updates:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Check for Updates';
            }
        }

        async function installUpdate() {
            if (!pendingUpdateUrl) {
                addStatus('No update URL available', 'error');
                return;
            }
            
            const installBtn = document.getElementById('install-update-btn');
            const updateAvailable = document.getElementById('update-available');
            const progressDiv = document.getElementById('update-progress');
            const progressText = document.getElementById('progress-text');
            const progressBar = document.getElementById('progress-bar');
            const completeDiv = document.getElementById('update-complete');
            
            // Hide update available, show progress
            updateAvailable.style.display = 'none';
            progressDiv.style.display = 'block';
            installBtn.disabled = true;
            
            try {
                // Start progress animation
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress = Math.min(progress + Math.random() * 5, 90);
                    progressBar.style.width = progress + '%';
                }, 500);
                
                addStatus('Downloading update...', 'info');
                progressText.textContent = 'Downloading update...';
                
                const result = await pywebview.api.install_update(pendingUpdateUrl);
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                if (result.success) {
                    progressDiv.style.display = 'none';
                    completeDiv.style.display = 'block';
                    addStatus(result.message, 'success');
                } else {
                    progressText.textContent = '‚ùå ' + result.message;
                    addStatus('Update failed: ' + result.message, 'error');
                }
                
            } catch (error) {
                progressText.textContent = '‚ùå Update failed: ' + error;
                addStatus('Update error: ' + error, 'error');
                console.error('Error installing update:', error);
            }
        }

        async function restartApp() {
            try {
                addStatus('Restarting application...', 'info');
                await pywebview.api.restart_application();
            } catch (error) {
                addStatus('Please manually restart the application.', 'warning');
                console.error('Error restarting:', error);
            }
        }
    </script>
</body>
</html>
